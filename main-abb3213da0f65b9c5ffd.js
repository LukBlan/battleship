(()=>{"use strict";class t{constructor(t){this.players=t,this.turnOrder=0}currentPlayer(){this.players[this.turnOrder]}}class e{constructor(t){this.board=t}}class i{constructor(t){this.length=t,this.hits=0}getLength(){return this.length}hit(){this.hits+=1}isSunk(){return this.hits>=this.length}}const n={};function o(t,e){void 0===n[t]&&(n[t]=[]),n[t].push(e)}function s(t,e){n[t].forEach((t=>t(e)))}function a(){s("place-ships-in-random-location",null)}function r(){s("reset-ships",null)}function c(t){t.target.classList.toggle("hover-effect")}function h(t,e){const i=document.createElement("div");return i.classList.add("cell"),function(t){t.addEventListener("dragenter",c),t.addEventListener("dragleave",c)}(i),t!==e.whiteSpace()&&t!==e.hitBoardMark()&&t!==e.missBoardMark()&&i.classList.add("ship-block"),i}function d(t){const e=t.clientX,i=t.target.childNodes,n=function(t,e){return Array.from(t).reduce(((t,i)=>{const n=i.getBoundingClientRect(),o=n.x+n.width/2,s=Math.abs(e-o);return i.offset=s,s<t.offset?i:t}),{offset:Number.POSITIVE_INFINITY})}(i,e);s("delta-ship-position",Array.from(i).indexOf(n))}function l(t){const e=t.target.children.length;s("ship-location-coordinates",{xPosition:t.clientX,yPosition:t.clientY,shipLength:e})}class p{constructor(){this.deltaPosition=null,this.boardElement=null}setDeltaPosition(t){this.deltaPosition=t}setBoardElement(t){t.addEventListener("click",this.rotateShip.bind(this)),this.boardElement=t}rotateShip(t){t.target.classList.contains("ship-block")&&(this.horizontalPosition=!this.horizontalPosition,s("rotate-ship",{column:this.getIndexOfElementInParent(t.target),row:this.getIndexOfElementInParent(t.target.parentElement)}))}init(){o("delta-ship-position",this.setDeltaPosition.bind(this)),o("ship-location-coordinates",this.placeShip.bind(this))}getCellFromPositions(t){const{xPosition:e}=t,{yPosition:i}=t;return Array.from(this.boardElement.childNodes).map((t=>Array.from(t.childNodes))).flat().reduce(((t,n)=>{const o=n.getBoundingClientRect(),s=o.y+o.height/2,a=o.x+o.width/2,r=(e-a)**2,c=(i-s)**2,h=Math.sqrt(r+c);return n.distance=h,h<t.distance?n:t}),{distance:Number.POSITIVE_INFINITY})}getIndexOfElementInParent(t){const e=t.parentElement;return Array.from(e.children).indexOf(t)}placeShip(t){const e=this.getCellFromPositions(t),{shipLength:i}=t,n=this.getIndexOfElementInParent(e)-this.deltaPosition;s("place-ship",{row:this.getIndexOfElementInParent(e.parentElement),column:n,shipLength:i})}}class u{constructor(t,e,i){this._coordinates=t,this._ship=e,this._horizontal=i}get coordinates(){return this._coordinates}get ship(){return this._ship}get horizontal(){return this._horizontal}}class g{constructor(t,e){this.xPosition=t,this.yPosition=e}getX(){return this.xPosition}getY(){return this.yPosition}}class m{constructor(t,e){this.boardFactory=t,this.board=t.createBoard(e),this.allLocatedShips=new Map,this.shipCount=0,this.size=e}setBoard(t){this.board=t}getBoard(){return this.board}removeShipFromLocation(t,e,i){const n=this.board[e][i],{coordinates:o,ship:s,horizontal:a}=t;let r=o.getX(),c=o.getY();const h=s.getLength();for(let t=0;t<h;t+=1)this.board[c][r]=this.boardFactory.whiteSpace(),a?r+=1:c+=1;this.allLocatedShips.delete(n)}getLocationObject(t,e){const i=this.board[t][e];return this.allLocatedShips.get(i)}getRotateLocation(t,e,i){const{coordinates:n,ship:o,horizontal:s}=t,a=n.getY(),r=n.getX();return new u(new g(s?i:i-(e-a),s?e-(i-r):e),o,!s)}rotateShip(t,e){const i=this.getLocationObject(t,e),n=this.getRotateLocation(i,t,e);this.removeShipFromLocation(i,t,e),this.placeShip(n)}canRotateShipOnLocation(t,e){const i=this.getLocationObject(t,e),n=new m(this.boardFactory,this.size),o=this.getRotateLocation(i,t,e),s=this.boardFactory.generateCopy(this.board);return n.setBoard(s),n.removeShipFromLocation(i,t,e),n.canPlaceShip(o)}attackPlace(t){const e=t.getX(),i=t.getY(),n=this.board[e][i];if(this.allLocatedShips.has(n)){const t=this.allLocatedShips.get(n),{ship:o}=t;o.hit(),this.board[e][i]=this.boardFactory.hitBoardMark()}else this.board[e][i]=this.boardFactory.missBoardMark()}allShipAreSunk(){const t=this.allLocatedShips.values();return Array.from(t).every((t=>{const{ship:e}=t;return e.isSunk()}))}canPlaceShip(t){return this.#t(t)&&this.#e(t)}placeShip(t){const{coordinates:e,ship:i,horizontal:n}=t;let o=e.getX(),s=e.getY();const a=i.getLength(),r=this.shipCount.toString();for(let t=0;t<a;t+=1)this.board[s][o]=r,n?o+=1:s+=1;this.allLocatedShips.set(r,t),this.shipCount+=1}#t(t){const{coordinates:e,ship:i,horizontal:n}=t,o=n?e.getX():e.getY(),s=i.length-1;return o>=0&&o+s<this.size}#e(t){const{coordinates:e,ship:i,horizontal:n}=t,o=i.getLength();let s=e.getX(),a=e.getY(),r=!0;for(let t=0;t<o;t+=1)r=r&&this.emptyLocation(a,s),n?s+=1:a+=1;return r}emptyLocation(t,e){return this.board[t][e]===this.boardFactory.whiteSpace()}}const b=[new i(3),new i(4),new i(1),new i(2),new i(3)],S=new class{whiteSpace(){return"-"}hitBoardMark(){return"x"}missBoardMark(){return"o"}createBoard(t){const e=[];for(let i=0;i<t;i+=1){const i=this.getBoardRow(t);e.push(i)}return e}getBoardRow(t){const e=this.whiteSpace(),i=[];for(let n=0;n<t;n+=1)i.push(e);return i}generateCopy(t){return t.map((t=>[...t]))}},f=new class{constructor(t,e){this.boardFctory=t,this.size=e,this.board=null,this.availableShips=null}init(){o("place-ship",this.placeShip.bind(this)),o("rotate-ship",this.rotateShip.bind(this))}setInitialShips(t){this.availableShips=t}build(){return this.board}rotateShip(t){const{row:e,column:i}=t;this.board.canRotateShipOnLocation(e,i)&&(this.board.rotateShip(e,i),this.emitBoard())}placeShip(t){const{row:e,column:n,shipLength:o}=t,s=new g(n,e),a=new i(o),r=new u(s,a,!0);this.board.canPlaceShip(r)&&(this.board.placeShip(r),this.removeAvailableShip(a),this.emitBoard())}removeAvailableShip(t){const e=this.availableShips.findIndex((e=>e.getLength()===t.getLength()));this.availableShips.splice(e,1)}reset(t){this.board=new m(this.boardFctory,this.size),this.availableShips=t,this.emitBoard()}placeInRandomPosition(){this.availableShips.forEach((t=>{this.placeShipInRandomPosition(t)})),this.availableShips=[],this.emitBoard()}placeShipInRandomPosition(t){const e=Math.floor(Math.random()*this.size),i=Math.floor(Math.random()*this.size),n=Math.random()<.5,o=new u(new g(e,i),t,n);this.board.canPlaceShip(o)?this.board.placeShip(o):this.placeShipInRandomPosition(t)}emitBoard(){s("board-change",{board:this.board.getBoard(),ships:this.availableShips})}}(S,8),L=new class{constructor(t,e){this.boardBuilder=t,this.initialShips=e}init(){o("place-ships-in-random-location",this.placeInRandomPosition.bind(this)),o("reset-ships",this.reset.bind(this)),this.boardBuilder.setInitialShips(this.getShipsCopy()),this.boardBuilder.init()}placeInRandomPosition(){this.reset(),this.boardBuilder.placeInRandomPosition()}reset(){this.boardBuilder.reset(this.getShipsCopy())}getShipsCopy(){return this.initialShips.map((t=>{const e=t.getLength();return new i(e)}))}create(){const i=this.boardBuilder.build(),n=new e(i);return new t([n])}}(f,b),w=new class{constructor(t){this.game=null,this.gameFactory=t}init(){o("configure-new-game",this.newGameConfiguration.bind(this))}newGameConfiguration(){this.gameFactory.reset()}}(L),v=document.querySelector(".game-section"),y=new class{constructor(t){this.gameSection=t,this.menuButton=document.querySelector(".menu-button"),this.newGameButton=function(){const t=document.createElement("button");return t.innerText="New Game",t.classList.add("new-game-button"),t.classList.add("option-button"),t}(),this.onClick=this.emitDisplayConfigurationScreen.bind(this)}init(){this.menuButton.addEventListener("click",this.toggleMenuOnScreen.bind(this)),this.toggleMenuOnScreen()}toggleMenuOnScreen(){this.gameSection.contains(this.newGameButton)?(this.newGameButton.removeEventListener("click",this.onClick),this.gameSection.removeChild(this.newGameButton)):(this.gameSection.append(this.newGameButton),this.newGameButton.addEventListener("click",this.onClick))}emitDisplayConfigurationScreen(){this.toggleMenuOnScreen(),s("configure-new-game",null)}}(v),E=new class{constructor(t,e){this.gameSection=t,this.configurationScreen=function(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("h2"),n=document.createElement("div"),o=function(){const t=document.createElement("div"),e=function(){const t=document.createElement("button");return t.innerText="Random",t.classList.add("option-button"),t.addEventListener("click",a),t}(),i=function(){const t=document.createElement("button");return t.innerText="Reset",t.classList.add("option-button"),t.addEventListener("click",r),t}();return t.classList.add("footer"),t.append(e),t.append(i),t}();return e.classList.add("board"),n.classList.add("ships-section"),t.classList.add("configuration-screen"),i.innerText="Arrange your boats",i.classList.add("configuration-title"),t.append(i),t.append(e),t.append(n),t.append(o),t}(),this.boardSection=this.configurationScreen.querySelector(".board"),this.shipSection=this.configurationScreen.querySelector(".ships-section"),this.boardFactory=e,this.placeShipInterface=new p(this.boardSection)}init(){o("configure-new-game",this.renderGameConfiguration.bind(this)),o("board-change",this.replaceConfigurationObjects.bind(this)),this.placeShipInterface.init()}replaceConfigurationObjects(t){const{board:e,ships:i}=t;this.replaceBoard(e),this.replaceShips(i)}replaceBoard(t){const e=function(t,e){const i=function(t,e){const i=document.createElement("div");i.addEventListener("dragover",(t=>{t.preventDefault()}));const n=t.length;for(let o=0;o<n;o+=1){const s=document.createElement("div");for(let i=0;i<n;i+=1){const n=h(t[o][i],e);s.append(n)}i.append(s)}return i}(t,e);return i.classList.add("board"),i}(t,this.boardFactory);this.configurationScreen.replaceChild(e,this.boardSection),this.placeShipInterface.setBoardElement(e),this.boardSection=e}replaceShips(t){const e=function(t){const e=document.createElement("div");return e.classList.add("ships-section"),t.forEach((t=>{const i=function(t){const e=function(t){const e=document.createElement("div");e.classList.add("ship"),e.draggable=!0;for(let i=0;i<t;i+=1){const t=document.createElement("div");t.classList.add("ship-block"),e.append(t)}return e}(t);return e.addEventListener("dragstart",d),e.addEventListener("dragend",l),e}(t.getLength());e.append(i)})),e}(t);console.log(this.shipSection),this.configurationScreen.replaceChild(e,this.shipSection),this.shipSection=e}renderGameConfiguration(){this.gameSection.append(this.configurationScreen)}}(v,S);L.init(),y.init(),E.init(),w.init()})();