(()=>{"use strict";class t{constructor(t){this.players=t,this.turnOrder=0}currentPlayer(){this.players[this.turnOrder]}}class e{constructor(t){this.board=t}}class i{constructor(t){this.length=t,this.hits=0}getLength(){return this.length}hit(){this.hits+=1}isSunk(){return this.hits>=this.length}}const n={};function o(t,e){void 0===n[t]&&(n[t]=[]),n[t].push(e)}function s(t,e){n[t].forEach((t=>t(e)))}function r(t,e){const i=document.createElement("div");return i.classList.add("cell"),t!==e.whiteSpace()&&t!==e.hitBoardMark()&&t!==e.missBoardMark()&&i.classList.add("ship-block"),i}function a(t){const e=t.clientX,i=t.target.childNodes,n=function(t,e){return Array.from(t).reduce(((t,i)=>{const n=i.getBoundingClientRect(),o=n.x+n.width/2,s=Math.abs(e-o);return i.offset=s,s<t.offset?i:t}),{offset:Number.POSITIVE_INFINITY})}(i,e);s("delta-ship-position",Array.from(i).indexOf(n))}function h(t){const e=t.target.children.length;s("ship-location-coordinates",{xPosition:t.clientX,yPosition:t.clientY,shipLength:e})}class c{constructor(){this.deltaPosition=null,this.boardElement=null}setDeltaPosition(t){this.deltaPosition=t}setBoardElement(t){t.addEventListener("click",this.rotateShip.bind(this)),this.boardElement=t}rotateShip(t){t.target.classList.contains("ship-block")&&(this.horizontalPosition=!this.horizontalPosition,s("rotate-ship",{column:this.getIndexOfElementInParent(t.target),row:this.getIndexOfElementInParent(t.target.parentElement)}))}init(){o("delta-ship-position",this.setDeltaPosition.bind(this)),o("ship-location-coordinates",this.placeShip.bind(this))}getCellFromPositions(t){const{xPosition:e}=t,{yPosition:i}=t;return Array.from(this.boardElement.childNodes).map((t=>Array.from(t.childNodes))).flat().reduce(((t,n)=>{const o=n.getBoundingClientRect(),s=o.y+o.height/2,r=o.x+o.width/2,a=(e-r)**2,h=(i-s)**2,c=Math.sqrt(a+h);return n.distance=c,c<t.distance?n:t}),{distance:Number.POSITIVE_INFINITY})}getIndexOfElementInParent(t){const e=t.parentElement;return Array.from(e.children).indexOf(t)}placeShip(t){const e=this.getCellFromPositions(t),{shipLength:i}=t,n=this.getIndexOfElementInParent(e)-this.deltaPosition;s("place-ship",{row:this.getIndexOfElementInParent(e.parentElement),column:n,shipLength:i})}}class d{constructor(t,e,i){this._coordinates=t,this._ship=e,this._horizontal=i}get coordinates(){return this._coordinates}get ship(){return this._ship}get horizontal(){return this._horizontal}}class l{constructor(t,e){this.xPosition=t,this.yPosition=e}getX(){return this.xPosition}getY(){return this.yPosition}}class u{constructor(t,e){this.boardFactory=t,this.board=t.createBoard(e),this.allLocatedShips=new Map,this.shipCount=0,this.size=e}setBoard(t){this.board=t}getBoard(){return this.board}removeShipFromLocation(t,e,i){const n=this.board[e][i],{coordinates:o,ship:s,horizontal:r}=t;let a=o.getX(),h=o.getY();const c=s.getLength();for(let t=0;t<c;t+=1)this.board[h][a]=this.boardFactory.whiteSpace(),r?a+=1:h+=1;this.allLocatedShips.delete(n)}getLocationObject(t,e){const i=this.board[t][e];return this.allLocatedShips.get(i)}getRotateLocation(t,e,i){const{coordinates:n,ship:o,horizontal:s}=t,r=n.getY(),a=n.getX();return new d(new l(s?i:i-(e-r),s?e-(i-a):e),o,!s)}rotateShip(t,e){const i=this.getLocationObject(t,e),n=this.getRotateLocation(i,t,e);this.removeShipFromLocation(i,t,e),this.placeShip(n)}canRotateShipOnLocation(t,e){const i=this.getLocationObject(t,e),n=new u(this.boardFactory,this.size),o=this.getRotateLocation(i,t,e),s=this.boardFactory.generateCopy(this.board);return n.setBoard(s),n.removeShipFromLocation(i,t,e),n.canPlaceShip(o)}attackPlace(t){const e=t.getX(),i=t.getY(),n=this.board[e][i];if(this.allLocatedShips.has(n)){const t=this.allLocatedShips.get(n),{ship:o}=t;o.hit(),this.board[e][i]=this.boardFactory.hitBoardMark()}else this.board[e][i]=this.boardFactory.missBoardMark()}allShipAreSunk(){const t=this.allLocatedShips.values();return Array.from(t).every((t=>{const{ship:e}=t;return e.isSunk()}))}canPlaceShip(t){return this.#t(t)&&this.#e(t)}placeShip(t){const{coordinates:e,ship:i,horizontal:n}=t;let o=e.getX(),s=e.getY();const r=i.getLength(),a=this.shipCount.toString();for(let t=0;t<r;t+=1)this.board[s][o]=a,n?o+=1:s+=1;this.allLocatedShips.set(a,t),this.shipCount+=1}#t(t){const{coordinates:e,ship:i,horizontal:n}=t,o=n?e.getX():e.getY(),s=i.length-1;return o>=0&&o+s<this.size}#e(t){const{coordinates:e,ship:i,horizontal:n}=t,o=i.getLength();let s=e.getX(),r=e.getY(),a=!0;for(let t=0;t<o;t+=1)a=a&&this.emptyLocation(r,s),n?s+=1:r+=1;return a}emptyLocation(t,e){return this.board[t][e]===this.boardFactory.whiteSpace()}}const p=[new i(3),new i(4),new i(1),new i(2),new i(3)],g=new class{whiteSpace(){return"-"}hitBoardMark(){return"x"}missBoardMark(){return"o"}createBoard(t){const e=[];for(let i=0;i<t;i+=1){const i=this.getBoardRow(t);e.push(i)}return e}getBoardRow(t){const e=this.whiteSpace(),i=[];for(let n=0;n<t;n+=1)i.push(e);return i}generateCopy(t){return t.map((t=>[...t]))}},m=new class{constructor(t,e){this.boardFctory=t,this.size=e,this.board=null,this.availableShips=null}init(){o("place-ship",this.placeShip.bind(this)),o("rotate-ship",this.rotateShip.bind(this))}setInitialShips(t){this.availableShips=t}build(){return this.board}rotateShip(t){const{row:e,column:i}=t;this.board.canRotateShipOnLocation(e,i)&&(this.board.rotateShip(e,i),this.emitBoard())}placeShip(t){const{row:e,column:n,shipLength:o}=t,s=new l(n,e),r=new i(o),a=new d(s,r,!0);this.board.canPlaceShip(a)&&(this.board.placeShip(a),this.removeAvailableShip(r),this.emitBoard())}removeAvailableShip(t){const e=this.availableShips.findIndex((e=>e.getLength()===t.getLength()));this.availableShips.splice(e,1)}reset(t){this.board=new u(this.boardFctory,this.size),this.availableShips=t,this.emitBoard()}emitBoard(){s("board-change",{board:this.board.getBoard(),ships:this.availableShips})}}(g,8),S=new class{constructor(t,e){this.boardBuilder=t,this.initialShips=e}init(){this.boardBuilder.setInitialShips(this.getShipsCopy()),this.boardBuilder.init()}reset(){this.boardBuilder.reset(this.getShipsCopy())}getShipsCopy(){return this.initialShips.map((t=>{const e=t.getLength();return new i(e)}))}create(){const i=this.boardBuilder.build(),n=new e(i);return new t([n])}}(m,p),b=new class{constructor(t){this.game=null,this.gameFactory=t}init(){o("configure-new-game",this.newGameConfiguration.bind(this))}newGameConfiguration(){this.gameFactory.reset()}}(S),f=document.querySelector(".game-section"),L=new class{constructor(t){this.gameSection=t,this.menuButton=document.querySelector(".menu-button"),this.newGameButton=function(){const t=document.createElement("button");return t.innerText="New Game",t.classList.add("new-game-button"),t}(),this.onClick=this.emitDisplayConfigurationScreen.bind(this)}init(){this.menuButton.addEventListener("click",this.toggleMenuOnScreen.bind(this)),this.toggleMenuOnScreen()}toggleMenuOnScreen(){this.gameSection.contains(this.newGameButton)?(this.newGameButton.removeEventListener("click",this.onClick),this.gameSection.removeChild(this.newGameButton)):(this.gameSection.append(this.newGameButton),this.newGameButton.addEventListener("click",this.onClick))}emitDisplayConfigurationScreen(){this.toggleMenuOnScreen(),s("configure-new-game",null)}}(f),w=new class{constructor(t,e){this.gameSection=t,this.configurationScreen=function(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("h2"),n=document.createElement("div"),o=document.createElement("div");return e.classList.add("board"),n.classList.add("ships-section"),t.classList.add("configuration-screen"),i.innerText="Arrange your boats",i.classList.add("configuration-title"),o.classList.add("footer"),t.append(i),t.append(e),t.append(n),t.append(o),t}(),this.boardSection=this.configurationScreen.querySelector(".board"),this.shipSection=this.configurationScreen.querySelector(".ships-section"),this.boardFactory=e,this.placeShipInterface=new c(this.boardSection)}init(){o("configure-new-game",this.renderGameConfiguration.bind(this)),o("board-change",this.replaceConfigurationObjects.bind(this)),this.placeShipInterface.init()}replaceConfigurationObjects(t){const{board:e,ships:i}=t;this.replaceBoard(e),this.replaceShips(i)}replaceBoard(t){const e=function(t,e){const i=function(t,e){const i=document.createElement("div");i.addEventListener("dragover",(t=>{t.preventDefault()}));const n=t.length;for(let o=0;o<n;o+=1){const s=document.createElement("div");for(let i=0;i<n;i+=1){const n=r(t[o][i],e);s.append(n)}i.append(s)}return i}(t,e);return i.classList.add("board"),i}(t,this.boardFactory);this.configurationScreen.replaceChild(e,this.boardSection),this.placeShipInterface.setBoardElement(e),this.boardSection=e}replaceShips(t){const e=function(t){const e=document.createElement("div");return e.classList.add("ships-section"),t.forEach((t=>{const i=function(t){const e=function(t){const e=document.createElement("div");e.classList.add("ship"),e.draggable=!0;for(let i=0;i<t;i+=1){const t=document.createElement("div");t.classList.add("ship-block"),e.append(t)}return e}(t);return e.addEventListener("dragstart",a),e.addEventListener("dragend",h),e}(t.getLength());e.append(i)})),e}(t);console.log(this.shipSection),this.configurationScreen.replaceChild(e,this.shipSection),this.shipSection=e}renderGameConfiguration(){this.gameSection.append(this.configurationScreen)}}(f,g);S.init(),L.init(),w.init(),b.init()})();