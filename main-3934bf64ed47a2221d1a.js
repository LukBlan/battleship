(()=>{"use strict";class t{constructor(t){this.players=t,this.turnOrder=0}currentPlayer(){this.players[this.turnOrder]}}class e{constructor(t){this.board=t}}class i{constructor(t){this.length=t,this.hits=0}getLength(){return this.length}hit(){this.hits+=1}isSunk(){return this.hits>=this.length}}const n={};function s(t,e){void 0===n[t]&&(n[t]=[]),n[t].push(e)}function o(t,e){n[t].forEach((t=>t(e)))}function r(t){t.target.classList.toggle("hover-effect")}function a(t,e){const i=document.createElement("div");return i.classList.add("cell"),function(t){t.addEventListener("dragenter",r),t.addEventListener("dragleave",r)}(i),t!==e.whiteSpace()&&t!==e.hitBoardMark()&&t!==e.missBoardMark()&&i.classList.add("ship-block"),i}function h(t){const e=t.clientX,i=t.target.childNodes,n=function(t,e){return Array.from(t).reduce(((t,i)=>{const n=i.getBoundingClientRect(),s=n.x+n.width/2,o=Math.abs(e-s);return i.offset=o,o<t.offset?i:t}),{offset:Number.POSITIVE_INFINITY})}(i,e);o("delta-ship-position",Array.from(i).indexOf(n))}function c(t){const e=t.target.children.length;o("ship-location-coordinates",{xPosition:t.clientX,yPosition:t.clientY,shipLength:e})}class d{constructor(){this.deltaPosition=null,this.boardElement=null}setDeltaPosition(t){this.deltaPosition=t}setBoardElement(t){t.addEventListener("click",this.rotateShip.bind(this)),this.boardElement=t}rotateShip(t){t.target.classList.contains("ship-block")&&(this.horizontalPosition=!this.horizontalPosition,o("rotate-ship",{column:this.getIndexOfElementInParent(t.target),row:this.getIndexOfElementInParent(t.target.parentElement)}))}init(){s("delta-ship-position",this.setDeltaPosition.bind(this)),s("ship-location-coordinates",this.placeShip.bind(this))}getCellFromPositions(t){const{xPosition:e}=t,{yPosition:i}=t;return Array.from(this.boardElement.childNodes).map((t=>Array.from(t.childNodes))).flat().reduce(((t,n)=>{const s=n.getBoundingClientRect(),o=s.y+s.height/2,r=s.x+s.width/2,a=(e-r)**2,h=(i-o)**2,c=Math.sqrt(a+h);return n.distance=c,c<t.distance?n:t}),{distance:Number.POSITIVE_INFINITY})}getIndexOfElementInParent(t){const e=t.parentElement;return Array.from(e.children).indexOf(t)}placeShip(t){const e=this.getCellFromPositions(t),{shipLength:i}=t,n=this.getIndexOfElementInParent(e)-this.deltaPosition;o("place-ship",{row:this.getIndexOfElementInParent(e.parentElement),column:n,shipLength:i})}}class l{constructor(t,e,i){this._coordinates=t,this._ship=e,this._horizontal=i}get coordinates(){return this._coordinates}get ship(){return this._ship}get horizontal(){return this._horizontal}}class u{constructor(t,e){this.xPosition=t,this.yPosition=e}getX(){return this.xPosition}getY(){return this.yPosition}}class p{constructor(t,e){this.boardFactory=t,this.board=t.createBoard(e),this.allLocatedShips=new Map,this.shipCount=0,this.size=e}setBoard(t){this.board=t}getBoard(){return this.board}removeShipFromLocation(t,e,i){const n=this.board[e][i],{coordinates:s,ship:o,horizontal:r}=t;let a=s.getX(),h=s.getY();const c=o.getLength();for(let t=0;t<c;t+=1)this.board[h][a]=this.boardFactory.whiteSpace(),r?a+=1:h+=1;this.allLocatedShips.delete(n)}getLocationObject(t,e){const i=this.board[t][e];return this.allLocatedShips.get(i)}getRotateLocation(t,e,i){const{coordinates:n,ship:s,horizontal:o}=t,r=n.getY(),a=n.getX();return new l(new u(o?i:i-(e-r),o?e-(i-a):e),s,!o)}rotateShip(t,e){const i=this.getLocationObject(t,e),n=this.getRotateLocation(i,t,e);this.removeShipFromLocation(i,t,e),this.placeShip(n)}canRotateShipOnLocation(t,e){const i=this.getLocationObject(t,e),n=new p(this.boardFactory,this.size),s=this.getRotateLocation(i,t,e),o=this.boardFactory.generateCopy(this.board);return n.setBoard(o),n.removeShipFromLocation(i,t,e),n.canPlaceShip(s)}attackPlace(t){const e=t.getX(),i=t.getY(),n=this.board[e][i];if(this.allLocatedShips.has(n)){const t=this.allLocatedShips.get(n),{ship:s}=t;s.hit(),this.board[e][i]=this.boardFactory.hitBoardMark()}else this.board[e][i]=this.boardFactory.missBoardMark()}allShipAreSunk(){const t=this.allLocatedShips.values();return Array.from(t).every((t=>{const{ship:e}=t;return e.isSunk()}))}canPlaceShip(t){return this.#t(t)&&this.#e(t)}placeShip(t){const{coordinates:e,ship:i,horizontal:n}=t;let s=e.getX(),o=e.getY();const r=i.getLength(),a=this.shipCount.toString();for(let t=0;t<r;t+=1)this.board[o][s]=a,n?s+=1:o+=1;this.allLocatedShips.set(a,t),this.shipCount+=1}#t(t){const{coordinates:e,ship:i,horizontal:n}=t,s=n?e.getX():e.getY(),o=i.length-1;return s>=0&&s+o<this.size}#e(t){const{coordinates:e,ship:i,horizontal:n}=t,s=i.getLength();let o=e.getX(),r=e.getY(),a=!0;for(let t=0;t<s;t+=1)a=a&&this.emptyLocation(r,o),n?o+=1:r+=1;return a}emptyLocation(t,e){return this.board[t][e]===this.boardFactory.whiteSpace()}}const g=[new i(3),new i(4),new i(1),new i(2),new i(3)],m=new class{whiteSpace(){return"-"}hitBoardMark(){return"x"}missBoardMark(){return"o"}createBoard(t){const e=[];for(let i=0;i<t;i+=1){const i=this.getBoardRow(t);e.push(i)}return e}getBoardRow(t){const e=this.whiteSpace(),i=[];for(let n=0;n<t;n+=1)i.push(e);return i}generateCopy(t){return t.map((t=>[...t]))}},S=new class{constructor(t,e){this.boardFctory=t,this.size=e,this.board=null,this.availableShips=null}init(){s("place-ship",this.placeShip.bind(this)),s("rotate-ship",this.rotateShip.bind(this))}setInitialShips(t){this.availableShips=t}build(){return this.board}rotateShip(t){const{row:e,column:i}=t;this.board.canRotateShipOnLocation(e,i)&&(this.board.rotateShip(e,i),this.emitBoard())}placeShip(t){const{row:e,column:n,shipLength:s}=t,o=new u(n,e),r=new i(s),a=new l(o,r,!0);this.board.canPlaceShip(a)&&(this.board.placeShip(a),this.removeAvailableShip(r),this.emitBoard())}removeAvailableShip(t){const e=this.availableShips.findIndex((e=>e.getLength()===t.getLength()));this.availableShips.splice(e,1)}reset(t){this.board=new p(this.boardFctory,this.size),this.availableShips=t,this.emitBoard()}emitBoard(){o("board-change",{board:this.board.getBoard(),ships:this.availableShips})}}(m,8),b=new class{constructor(t,e){this.boardBuilder=t,this.initialShips=e}init(){this.boardBuilder.setInitialShips(this.getShipsCopy()),this.boardBuilder.init()}reset(){this.boardBuilder.reset(this.getShipsCopy())}getShipsCopy(){return this.initialShips.map((t=>{const e=t.getLength();return new i(e)}))}create(){const i=this.boardBuilder.build(),n=new e(i);return new t([n])}}(S,g),f=new class{constructor(t){this.game=null,this.gameFactory=t}init(){s("configure-new-game",this.newGameConfiguration.bind(this))}newGameConfiguration(){this.gameFactory.reset()}}(b),L=document.querySelector(".game-section"),w=new class{constructor(t){this.gameSection=t,this.menuButton=document.querySelector(".menu-button"),this.newGameButton=function(){const t=document.createElement("button");return t.innerText="New Game",t.classList.add("new-game-button"),t}(),this.onClick=this.emitDisplayConfigurationScreen.bind(this)}init(){this.menuButton.addEventListener("click",this.toggleMenuOnScreen.bind(this)),this.toggleMenuOnScreen()}toggleMenuOnScreen(){this.gameSection.contains(this.newGameButton)?(this.newGameButton.removeEventListener("click",this.onClick),this.gameSection.removeChild(this.newGameButton)):(this.gameSection.append(this.newGameButton),this.newGameButton.addEventListener("click",this.onClick))}emitDisplayConfigurationScreen(){this.toggleMenuOnScreen(),o("configure-new-game",null)}}(L),y=new class{constructor(t,e){this.gameSection=t,this.configurationScreen=function(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("h2"),n=document.createElement("div"),s=document.createElement("div");return e.classList.add("board"),n.classList.add("ships-section"),t.classList.add("configuration-screen"),i.innerText="Arrange your boats",i.classList.add("configuration-title"),s.classList.add("footer"),t.append(i),t.append(e),t.append(n),t.append(s),t}(),this.boardSection=this.configurationScreen.querySelector(".board"),this.shipSection=this.configurationScreen.querySelector(".ships-section"),this.boardFactory=e,this.placeShipInterface=new d(this.boardSection)}init(){s("configure-new-game",this.renderGameConfiguration.bind(this)),s("board-change",this.replaceConfigurationObjects.bind(this)),this.placeShipInterface.init()}replaceConfigurationObjects(t){const{board:e,ships:i}=t;this.replaceBoard(e),this.replaceShips(i)}replaceBoard(t){const e=function(t,e){const i=function(t,e){const i=document.createElement("div");i.addEventListener("dragover",(t=>{t.preventDefault()}));const n=t.length;for(let s=0;s<n;s+=1){const o=document.createElement("div");for(let i=0;i<n;i+=1){const n=a(t[s][i],e);o.append(n)}i.append(o)}return i}(t,e);return i.classList.add("board"),i}(t,this.boardFactory);this.configurationScreen.replaceChild(e,this.boardSection),this.placeShipInterface.setBoardElement(e),this.boardSection=e}replaceShips(t){const e=function(t){const e=document.createElement("div");return e.classList.add("ships-section"),t.forEach((t=>{const i=function(t){const e=function(t){const e=document.createElement("div");e.classList.add("ship"),e.draggable=!0;for(let i=0;i<t;i+=1){const t=document.createElement("div");t.classList.add("ship-block"),e.append(t)}return e}(t);return e.addEventListener("dragstart",h),e.addEventListener("dragend",c),e}(t.getLength());e.append(i)})),e}(t);console.log(this.shipSection),this.configurationScreen.replaceChild(e,this.shipSection),this.shipSection=e}renderGameConfiguration(){this.gameSection.append(this.configurationScreen)}}(L,m);b.init(),w.init(),y.init(),f.init()})();