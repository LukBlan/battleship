(()=>{"use strict";class t{constructor(t){this.players=t,this.turnOrder=0}currentPlayer(){this.players[this.turnOrder]}}class e{constructor(t){this.board=t}}const i={};function n(t,e){void 0===i[t]&&(i[t]=[]),i[t].push(e)}function o(t,e){i[t].forEach((t=>t(e)))}function s(t,e){const i=document.createElement("div");return i.classList.add("cell"),t!==e.whiteSpace()&&t!==e.hitBoardMark()&&t!==e.missBoardMark()&&i.classList.add("ship-block"),i}class r{constructor(){this.deltaPosition=null,this.boardElement=null}setDeltaPosition(t){this.deltaPosition=t}setBoardElement(t){t.addEventListener("click",this.rotateShip.bind(this)),this.boardElement=t}rotateShip(t){t.target.classList.contains("ship-block")&&(this.horizontalPosition=!this.horizontalPosition,o("rotate-ship",{column:this.getIndexOfElementInParent(t.target),row:this.getIndexOfElementInParent(t.target.parentElement)}))}init(){n("delta-ship-position",this.setDeltaPosition.bind(this)),n("ship-location-coordinates",this.placeShip.bind(this))}getCellFromPositions(t){const{xPosition:e}=t,{yPosition:i}=t;return Array.from(this.boardElement.childNodes).map((t=>Array.from(t.childNodes))).flat().reduce(((t,n)=>{const o=n.getBoundingClientRect(),s=o.y+o.height/2,r=o.x+o.width/2,a=(e-r)**2,c=(i-s)**2,h=Math.sqrt(a+c);return n.distance=h,h<t.distance?n:t}),{distance:Number.POSITIVE_INFINITY})}getIndexOfElementInParent(t){const e=t.parentElement;return Array.from(e.children).indexOf(t)}placeShip(t){const e=this.getCellFromPositions(t),{shipLength:i}=t,n=this.getIndexOfElementInParent(e)-this.deltaPosition;o("place-ship",{row:this.getIndexOfElementInParent(e.parentElement),column:n,shipLength:i})}}function a(t){const e=t.clientX,i=t.target.childNodes,n=function(t,e){return Array.from(t).reduce(((t,i)=>{const n=i.getBoundingClientRect(),o=n.x+n.width/2,s=Math.abs(e-o);return i.offset=s,s<t.offset?i:t}),{offset:Number.POSITIVE_INFINITY})}(i,e);o("delta-ship-position",Array.from(i).indexOf(n))}function c(t){const e=t.target.children.length;o("ship-location-coordinates",{xPosition:t.clientX,yPosition:t.clientY,shipLength:e})}function h(t){const e=function(t){const e=document.createElement("div");e.classList.add("ship"),e.draggable=!0;for(let i=0;i<t;i+=1){const t=document.createElement("div");t.classList.add("ship-block"),e.append(t)}return e}(t);return e.addEventListener("dragstart",a),e.addEventListener("dragend",c),e}class d{constructor(t,e,i){this._coordinates=t,this._ship=e,this._horizontal=i}get coordinates(){return this._coordinates}get ship(){return this._ship}get horizontal(){return this._horizontal}}class l{constructor(t,e){this.xPosition=t,this.yPosition=e}getX(){return this.xPosition}getY(){return this.yPosition}}class u{constructor(t,e){this.boardFactory=t,this.board=t.createBoard(e),this.allLocatedShips=new Map,this.shipCount=0,this.size=e}setBoard(t){this.board=t}getBoard(){return this.board}removeShipFromLocation(t,e,i){const n=this.board[e][i],{coordinates:o,ship:s,horizontal:r}=t;let a=o.getX(),c=o.getY();const h=s.getLength();for(let t=0;t<h;t+=1)this.board[c][a]=this.boardFactory.whiteSpace(),r?a+=1:c+=1;this.allLocatedShips.delete(n)}getLocationObject(t,e){const i=this.board[t][e];return this.allLocatedShips.get(i)}getRotateLocation(t,e,i){const{coordinates:n,ship:o,horizontal:s}=t,r=n.getY(),a=n.getX();return new d(new l(s?i:i-(e-r),s?e-(i-a):e),o,!s)}rotateShip(t,e){const i=this.getLocationObject(t,e),n=this.getRotateLocation(i,t,e);this.removeShipFromLocation(i,t,e),this.placeShip(n)}canRotateShipOnLocation(t,e){const i=this.getLocationObject(t,e),n=new u(this.boardFactory,this.size),o=this.getRotateLocation(i,t,e),s=this.boardFactory.generateCopy(this.board);return n.setBoard(s),n.removeShipFromLocation(i,t,e),n.canPlaceShip(o)}attackPlace(t){const e=t.getX(),i=t.getY(),n=this.board[e][i];if(this.allLocatedShips.has(n)){const t=this.allLocatedShips.get(n),{ship:o}=t;o.hit(),this.board[e][i]=this.boardFactory.hitBoardMark()}else this.board[e][i]=this.boardFactory.missBoardMark()}allShipAreSunk(){const t=this.allLocatedShips.values();return Array.from(t).every((t=>{const{ship:e}=t;return e.isSunk()}))}canPlaceShip(t){return this.#t(t)&&this.#e(t)}placeShip(t){const{coordinates:e,ship:i,horizontal:n}=t;let o=e.getX(),s=e.getY();const r=i.getLength(),a=this.shipCount.toString();for(let t=0;t<r;t+=1)this.board[s][o]=a,n?o+=1:s+=1;this.allLocatedShips.set(a,t),this.shipCount+=1}#t(t){const{coordinates:e,ship:i,horizontal:n}=t,o=n?e.getX():e.getY(),s=i.length-1;return o>=0&&o+s<this.size}#e(t){const{coordinates:e,ship:i,horizontal:n}=t,o=i.getLength();let s=e.getX(),r=e.getY(),a=!0;for(let t=0;t<o;t+=1)a=a&&this.emptyLocation(r,s),n?s+=1:r+=1,t+=1;return a}emptyLocation(t,e){return this.board[t][e]===this.boardFactory.whiteSpace()}}class p{constructor(t){this.length=t,this.hits=0}getLength(){return this.length}hit(){this.hits+=1}isSunk(){return this.hits>=this.length}}const g=[h(3),h(4),h(1),h(2),h(3)],m=new class{whiteSpace(){return"-"}hitBoardMark(){return"x"}missBoardMark(){return"o"}createBoard(t){const e=[];for(let i=0;i<t;i+=1){const i=this.getBoardRow(t);e.push(i)}return e}getBoardRow(t){const e=this.whiteSpace(),i=[];for(let n=0;n<t;n+=1)i.push(e);return i}generateCopy(t){return t.map((t=>[...t]))}},b=new class{constructor(t,e){this.boardFctory=t,this.size=e,this.board=null}init(){n("place-ship",this.placeShip.bind(this)),n("rotate-ship",this.rotateShip.bind(this))}rotateShip(t){const{row:e,column:i}=t;this.board.canRotateShipOnLocation(e,i)&&(this.board.rotateShip(e,i),this.emitBoard())}placeShip(t){const{row:e,column:i,shipLength:n}=t,o=new l(i,e),s=new p(n),r=new d(o,s,!0);this.board.canPlaceShip(r)&&(this.board.placeShip(r),this.emitBoard())}reset(){this.board=new u(this.boardFctory,this.size),this.emitBoard()}emitBoard(){o("board-change",this.board.getBoard())}}(m,7),S=new class{constructor(t){this.boardBuilder=t}reset(){this.boardBuilder.reset()}create(){const i=this.boardBuilder.build(),n=new e(i);return new t([n])}}(b),f=new class{constructor(t){this.game=null,this.gameFactory=t}init(){n("configure-new-game",this.newGameConfiguration.bind(this))}newGameConfiguration(){this.gameFactory.reset()}}(S),L=document.querySelector(".game-section"),w=new class{constructor(t){this.gameSection=t,this.menuButton=document.querySelector(".menu-button"),this.newGameButton=function(){const t=document.createElement("button");return t.innerText="New Game",t.classList.add("new-game-button"),t}(),this.onClick=this.emitDisplayConfigurationScreen.bind(this)}init(){this.menuButton.addEventListener("click",this.toggleMenuOnScreen.bind(this)),this.toggleMenuOnScreen()}toggleMenuOnScreen(){this.gameSection.contains(this.newGameButton)?(this.newGameButton.removeEventListener("click",this.onClick),this.gameSection.removeChild(this.newGameButton)):(this.gameSection.append(this.newGameButton),this.newGameButton.addEventListener("click",this.onClick))}emitDisplayConfigurationScreen(){this.toggleMenuOnScreen(),o("configure-new-game",null)}}(L),y=new class{constructor(t,e,i){this.gameSection=t,this.ships=e,this.configurationScreen=function(t){const e=document.createElement("div"),i=document.createElement("div"),n=document.createElement("h2"),o=function(t){const e=document.createElement("div");return t.forEach((t=>{e.append(t)})),e}(t);return i.classList.add("board"),o.classList.add("ships-section"),e.classList.add("configuration-screen"),n.innerText="Arrange your boats",n.classList.add("configuration-title"),e.append(n),e.append(i),e.append(o),e}(this.ships),this.boardSection=this.configurationScreen.querySelector(".board"),this.boardFactory=i,this.placeShipInterface=new r(this.boardSection)}init(){n("configure-new-game",this.renderGameConfiguration.bind(this)),n("board-change",this.replaceBoard.bind(this)),this.placeShipInterface.init()}replaceBoard(t){const e=function(t,e){const i=function(t,e){const i=document.createElement("div");i.addEventListener("dragover",(t=>{t.preventDefault()}));const n=t.length;for(let o=0;o<n;o+=1){const r=document.createElement("div");for(let i=0;i<n;i+=1){const n=s(t[o][i],e);r.append(n)}i.append(r)}return i}(t,e);return i.classList.add("board"),i}(t,this.boardFactory);this.configurationScreen.replaceChild(e,this.boardSection),this.placeShipInterface.setBoardElement(e),this.boardSection=e}renderGameConfiguration(){this.gameSection.append(this.configurationScreen)}}(L,g,m);b.init(),w.init(),y.init(),f.init()})();